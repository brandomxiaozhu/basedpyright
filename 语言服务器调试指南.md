# BasedPyright 语言服务器调试指南

## 1. 语言服务器启动和关闭

### 启动语言服务器

#### 方法一：使用 npm 脚本（推荐）
```bash
# 启动语言服务器（stdio 模式）
npm run run:langserver
```

#### 方法二：直接使用 Node.js
```bash
# 先构建项目
npm run build:cli:dev

# 启动语言服务器
node packages/pyright/langserver.index.js --stdio
```

#### 方法三：使用 Python 模块启动
```bash
# 使用 Python 包装器启动语言服务器
python -m basedpyright --langserver
```

### 关闭语言服务器

- **在终端中**：按 `Ctrl+C` 停止进程
- **在 PowerShell 中**：按 `Ctrl+C` 或关闭终端窗口
- **程序化关闭**：发送 LSP `shutdown` 和 `exit` 消息

## 2. VSCode 插件构建和调试

### 构建 VSCode 插件

```bash
# 构建开发版本的 VSCode 插件
npm run build:extension:dev

# 构建生产版本的 VSCode 插件
npm run build:extension
```

### 调试 VSCode 插件中的语言服务器

#### 步骤 1：准备调试环境

1. 在 VSCode 中打开 BasedPyright 项目
2. 确保已安装 VSCode 扩展开发所需的依赖

#### 步骤 2：启动调试会话

1. 按 `F5` 或使用 "Run and Debug" 面板
2. 选择 "Launch Extension" 配置
3. 这会启动一个新的 VSCode 窗口（Extension Development Host）

#### 步骤 3：调试语言服务器

**方法一：使用 VSCode 内置调试**
```bash
# 在项目根目录下，启动带调试的语言服务器
node --inspect packages/pyright/langserver.index.js --stdio
```

**方法二：使用日志调试**
```bash
# 启动语言服务器并输出详细日志
node packages/pyright/langserver.index.js --stdio --verbose
```

**方法三：使用 LSP 开发工具**
```bash
# 使用 lsp-devtools 检查 LSP 通信
npm run lsp-inspect

# 或者使用客户端工具
npm run lsp-client
```

## 3. 常用调试命令

### 检查语言服务器状态
```bash
# 检查版本
npm run run:cli -- --version

# 检查帮助信息
npm run run:cli -- --help

# 运行类型检查（测试语言服务器核心功能）
npm run run:cli -- test_functionality.py
```

### 监控和日志
```bash
# 启动监控模式（文件变化时自动重新检查）
npm run run:cli -- --watch test_functionality.py

# 输出详细诊断信息
npm run run:cli -- --verbose test_functionality.py

# 输出性能统计
npm run run:cli -- --stats test_functionality.py
```

## 4. 调试技巧

### 对于 Python 开发者的建议

1. **理解 LSP 协议**：语言服务器使用 Language Server Protocol (LSP) 与编辑器通信
2. **日志是关键**：使用 `--verbose` 参数查看详细日志
3. **测试文件**：创建简单的 Python 文件来测试特定功能
4. **分步调试**：先确保 CLI 工作正常，再测试语言服务器

### 常见问题排查

1. **语言服务器无法启动**
   ```bash
   # 检查 Node.js 版本
   node --version
   
   # 重新构建项目
   npm run build:cli:dev
   ```

2. **类型检查不工作**
   ```bash
   # 检查 Python 路径配置
   npm run run:cli -- --pythonpath /path/to/python
   
   # 检查虚拟环境
   npm run run:cli -- --venvpath /path/to/venv
   ```

3. **VSCode 插件问题**
   ```bash
   # 重新安装依赖
   npm install
   
   # 清理并重建
   npm run clean && npm run build:extension:dev
   ```

## 5. 开发工作流

### 修改代码后的测试流程

1. **修改 TypeScript 代码后**：
   ```bash
   npm run build:cli:dev
   npm run run:cli -- test_functionality.py
   ```

2. **修改 Python 代码后**：
   ```bash
   python -m basedpyright test_functionality.py
   ```

3. **修改 VSCode 插件代码后**：
   ```bash
   npm run build:extension:dev
   # 然后在 VSCode 中重新加载插件
   ```

### 自动化测试
```bash
# 运行所有测试
npm run test-python  # Python 测试
npm run jest         # JavaScript/TypeScript 测试
npm run check        # 代码质量检查
```

## 6. 有用的配置文件

- `.vscode/launch.json` - VSCode 调试配置
- `.vscode/tasks.json` - VSCode 任务配置
- `packages/pyright/src/` - 语言服务器核心代码
- `packages/vscode-pyright/src/` - VSCode 插件代码

通过这些步骤，即使不熟悉 JavaScript/Node.js，也能有效地调试和开发 BasedPyright 语言服务器功能。